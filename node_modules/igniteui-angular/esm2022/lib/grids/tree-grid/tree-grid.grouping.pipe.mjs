import { Pipe } from '@angular/core';
import { formatDate } from '../../core/utils';
import { GridColumnDataType } from '../../data-operations/data-util';
import { IgxSorting } from '../common/strategy';
import * as i0 from "@angular/core";
const HIDDEN_FIELD_NAME = '_Igx_Hidden_Data_';
/**
 * @hidden
 * @internal
 */
class GroupByRecord {
}
export class ITreeGridAggregation {
}
export class IgxGroupedTreeGridSorting extends IgxSorting {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new IgxGroupedTreeGridSorting());
    }
    getFieldValue(obj, key, isDate = false, isTime = false) {
        const data = obj.data[HIDDEN_FIELD_NAME] ?
            obj.data.hasOwnProperty(key) ?
                obj.data :
                obj.data[HIDDEN_FIELD_NAME] :
            obj.data;
        return super.getFieldValue(data, key, isDate, isTime);
    }
}
/** @hidden */
export class IgxTreeGridGroupingPipe {
    transform(collection, groupingExpressions, groupKey, childDataKey, grid, aggregations) {
        if (groupingExpressions.length === 0) {
            return collection;
        }
        if (groupKey?.toLowerCase() === childDataKey?.toLowerCase()) {
            throw new Error('Group key and child data key cannot be the same.');
        }
        this.grid = grid;
        const result = [];
        const groupedRecords = this.groupByMultiple(collection, groupingExpressions);
        this.flattenGrouping(groupedRecords, groupKey, childDataKey, result, aggregations);
        return result;
    }
    flattenGrouping(groupRecords, groupKey, childDataKey, data, aggregations = []) {
        for (const groupRecord of groupRecords) {
            const parent = {};
            const children = groupRecord.records;
            parent[childDataKey] = [];
            for (const aggregation of aggregations) {
                parent[aggregation.field] = aggregation.aggregate(parent, children);
            }
            parent[groupKey] = groupRecord.value + ` (${groupRecord.records.length})`;
            parent[HIDDEN_FIELD_NAME] = { [groupRecord.key]: groupRecord.value };
            data.push(parent);
            if (groupRecord.groups) {
                this.flattenGrouping(groupRecord.groups, groupKey, childDataKey, parent[childDataKey], aggregations);
            }
            else {
                parent[childDataKey] = children;
            }
        }
    }
    groupByMultiple(array, groupingExpressions, index = 0) {
        const res = this.groupBy(array, groupingExpressions[index]);
        if (index + 1 < groupingExpressions.length) {
            for (const groupByRecord of res) {
                groupByRecord.groups = this.groupByMultiple(groupByRecord.records, groupingExpressions, index + 1);
            }
        }
        return res;
    }
    groupBy(array, groupingExpression) {
        const key = groupingExpression.fieldName;
        const column = this.grid?.getColumnByName(key);
        const isDateTime = column?.dataType === GridColumnDataType.Date ||
            column?.dataType === GridColumnDataType.DateTime ||
            column?.dataType === GridColumnDataType.Time;
        const map = new Map();
        for (const record of array) {
            const value = isDateTime
                ? formatDate(record[key], column.pipeArgs.format, this.grid.locale)
                : record[key];
            let valueCase = value;
            let groupByRecord;
            if (groupingExpression.ignoreCase) {
                valueCase = value?.toString().toLowerCase();
            }
            if (map.has(valueCase)) {
                groupByRecord = map.get(valueCase);
            }
            else {
                groupByRecord = new GroupByRecord();
                groupByRecord.key = key;
                groupByRecord.value = value;
                groupByRecord.records = [];
                map.set(valueCase, groupByRecord);
            }
            groupByRecord.records.push(record);
        }
        return Array.from(map.values());
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: IgxTreeGridGroupingPipe, deps: [], target: i0.ɵɵFactoryTarget.Pipe }); }
    static { this.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "14.0.0", version: "17.2.4", ngImport: i0, type: IgxTreeGridGroupingPipe, isStandalone: true, name: "treeGridGrouping" }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: IgxTreeGridGroupingPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'treeGridGrouping',
                    standalone: true
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ncmlkLmdyb3VwaW5nLnBpcGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZ3JpZHMvdHJlZS1ncmlkL3RyZWUtZ3JpZC5ncm91cGluZy5waXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUdyRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7O0FBRWhELE1BQU0saUJBQWlCLEdBQUcsbUJBQW1CLENBQUM7QUFFOUM7OztHQUdHO0FBQ0gsTUFBTSxhQUFhO0NBS2xCO0FBRUQsTUFBTSxPQUFPLG9CQUFvQjtDQUdoQztBQUVELE1BQU0sT0FBTyx5QkFBMEIsU0FBUSxVQUFVO2FBQ3RDLGNBQVMsR0FBOEIsSUFBSSxDQUFDO0lBRXBELE1BQU0sQ0FBQyxRQUFRO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSx5QkFBeUIsRUFBRSxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVrQixhQUFhLENBQUMsR0FBUSxFQUFFLEdBQVcsRUFBRSxNQUFNLEdBQUcsS0FBSyxFQUFFLE1BQU0sR0FBRyxLQUFLO1FBQ2xGLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDVixHQUFHLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFD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Z0JBQ3hCLGFBQWEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO2dCQUM1QixhQUFhLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztnQkFDM0IsR0FBRyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7YUFDckM7WUFFRCxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN0QztRQUVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNwQyxDQUFDOzhHQXBHUSx1QkFBdUI7NEdBQXZCLHVCQUF1Qjs7MkZBQXZCLHVCQUF1QjtrQkFKbkMsSUFBSTttQkFBQztvQkFDRixJQUFJLEVBQUUsa0JBQWtCO29CQUN4QixVQUFVLEVBQUUsSUFBSTtpQkFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmb3JtYXREYXRlIH0gZnJvbSAnLi4vLi4vY29yZS91dGlscyc7XG5pbXBvcnQgeyBHcmlkQ29sdW1uRGF0YVR5cGUgfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZGF0YS11dGlsJztcbmltcG9ydCB7IElHcm91cGluZ0V4cHJlc3Npb24gfSBmcm9tICcuLi8uLi9kYXRhLW9wZXJhdGlvbnMvZ3JvdXBpbmctZXhwcmVzc2lvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgR3JpZFR5cGUgfSBmcm9tICcuLi9jb21tb24vZ3JpZC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgSWd4U29ydGluZyB9IGZyb20gJy4uL2NvbW1vbi9zdHJhdGVneSc7XG5cbmNvbnN0IEhJRERFTl9GSUVMRF9OQU1FID0gJ19JZ3hfSGlkZGVuX0RhdGFfJztcblxuLyoqXG4gKiBAaGlkZGVuXG4gKiBAaW50ZXJuYWxcbiAqL1xuY2xhc3MgR3JvdXBCeVJlY29yZCB7XG4gICAgcHVibGljIGtleTogc3RyaW5nO1xuICAgIHB1YmxpYyB2YWx1ZTogYW55O1xuICAgIHB1YmxpYyBncm91cHM6IEdyb3VwQnlSZWNvcmRbXTtcbiAgICBwdWJsaWMgcmVjb3JkczogYW55W107XG59XG5cbmV4cG9ydCBjbGFzcyBJVHJlZUdyaWRBZ2dyZWdhdGlvbiB7XG4gICAgcHVibGljIGZpZWxkOiBzdHJpbmc7XG4gICAgcHVibGljIGFnZ3JlZ2F0ZTogKHBhcmVudDogYW55LCBjaGlsZHJlbjogYW55W10pID0+IGFueTtcbn1cblxuZXhwb3J0IGNsYXNzIElneEdyb3VwZWRUcmVlR3JpZFNvcnRpbmcgZXh0ZW5kcyBJZ3hTb3J0aW5nIHtcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6IElneEdyb3VwZWRUcmVlR3JpZFNvcnRpbmcgPSBudWxsO1xuXG4gICAgcHVibGljIHN0YXRpYyBpbnN0YW5jZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlIHx8ICh0aGlzLl9pbnN0YW5jZSA9IG5ldyBJZ3hHcm91cGVkVHJlZUdyaWRTb3J0aW5nKCkpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBvdmVycmlkZSBnZXRGaWVsZFZhbHVlKG9iajogYW55LCBrZXk6IHN0cmluZywgaXNEYXRlID0gZmFsc2UsIGlzVGltZSA9IGZhbHNlKTogYW55IHtcbiAgICAgICAgY29uc3QgZGF0YSA9IG9iai5kYXRhW0hJRERFTl9GSUVMRF9OQU1FXSA/XG4gICAgICAgICAgICBvYmouZGF0YS5oYXNPd25Qcm9wZXJ0eShrZXkpID9cbiAgICAgICAgICAgICAgICBvYmouZGF0YSA6XG4gICAgICAgICAgICAgICAgb2JqLmRhdGFbSElEREVOX0ZJRUxEX05BTUVdIDpcbiAgICAgICAgICAgIG9iai5kYXRhO1xuXG4gICAgICAgIHJldHVybiBzdXBlci5nZXRGaWVsZFZhbHVlKGRhdGEsIGtleSwgaXNEYXRlLCBpc1RpbWUpO1xuICAgIH1cbn1cblxuLyoqIEBoaWRkZW4gKi9cbkBQaXBlKHtcbiAgICBuYW1lOiAndHJlZUdyaWRHcm91cGluZycsXG4gICAgc3RhbmRhbG9uZTogdHJ1ZVxufSlcbmV4cG9ydCBjbGFzcyBJZ3hUcmVlR3JpZEdyb3VwaW5nUGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xuICAgIHByaXZhdGUgZ3JpZDogR3JpZFR5cGU7XG5cbiAgICBwdWJsaWMgdHJhbnNmb3JtKGNvbGxlY3Rpb246IGFueVtdLFxuICAgICAgICAgICAgICAgICAgICAgZ3JvdXBpbmdFeHByZXNzaW9uczogSUdyb3VwaW5nRXhwcmVzc2lvbltdLFxuICAgICAgICAgICAgICAgICAgICAgZ3JvdXBLZXk6IHN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgIGNoaWxkRGF0YUtleTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgZ3JpZDogR3JpZFR5cGUsXG4gICAgICAgICAgICAgICAgICAgICBhZ2dyZWdhdGlvbnM/OiBJVHJlZUdyaWRBZ2dyZWdhdGlvbltdXG4gICAgICAgICAgICAgICAgICAgICk6IGFueVtdIHtcbiAgICAgICAgaWYgKGdyb3VwaW5nRXhwcmVzc2lvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gY29sbGVjdGlvbjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChncm91cEtleT8udG9Mb3dlckNhc2UoKSA9PT0gY2hpbGREYXRhS2V5Py50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dyb3VwIGtleSBhbmQgY2hpbGQgZGF0YSBrZXkgY2Fubm90IGJlIHRoZSBzYW1lLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5ncmlkID0gZ3JpZDtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcbiAgICAgICAgY29uc3QgZ3JvdXBlZFJlY29yZHMgPSB0aGlzLmdyb3VwQnlNdWx0aXBsZShjb2xsZWN0aW9uLCBncm91cGluZ0V4cHJlc3Npb25zKTtcbiAgICAgICAgdGhpcy5mbGF0dGVuR3JvdXBpbmcoZ3JvdXBlZFJlY29yZHMsIGdyb3VwS2V5LFxuICAgICAgICAgICAgY2hpbGREYXRhS2V5LCByZXN1bHQsIGFnZ3JlZ2F0aW9ucyk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZsYXR0ZW5Hcm91cGluZyhncm91cFJlY29yZHM6IEdyb3VwQnlSZWNvcmRbXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cEtleTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkRGF0YUtleTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IGFueVtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFnZ3JlZ2F0aW9uczogSVRyZWVHcmlkQWdncmVnYXRpb25bXSA9IFtdKSB7XG4gICAgICAgIGZvciAoY29uc3QgZ3JvdXBSZWNvcmQgb2YgZ3JvdXBSZWNvcmRzKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgPSB7fTtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkcmVuID0gZ3JvdXBSZWNvcmQucmVjb3JkcztcblxuICAgICAgICAgICAgcGFyZW50W2NoaWxkRGF0YUtleV0gPSBbXTtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBhZ2dyZWdhdGlvbiBvZiBhZ2dyZWdhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnRbYWdncmVnYXRpb24uZmllbGRdID0gYWdncmVnYXRpb24uYWdncmVnYXRlKHBhcmVudCwgY2hpbGRyZW4pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBwYXJlbnRbZ3JvdXBLZXldID0gZ3JvdXBSZWNvcmQudmFsdWUgKyBgICgke2dyb3VwUmVjb3JkLnJlY29yZHMubGVuZ3RofSlgO1xuICAgICAgICAgICAgcGFyZW50W0hJRERFTl9GSUVMRF9OQU1FXSA9IHsgW2dyb3VwUmVjb3JkLmtleV06IGdyb3VwUmVjb3JkLnZhbHVlIH07XG4gICAgICAgICAgICBkYXRhLnB1c2gocGFyZW50KTtcblxuICAgICAgICAgICAgaWYgKGdyb3VwUmVjb3JkLmdyb3Vwcykge1xuICAgICAgICAgICAgICAgIHRoaXMuZmxhdHRlbkdyb3VwaW5nKGdyb3VwUmVjb3JkLmdyb3VwcywgZ3JvdXBLZXksIGNoaWxkRGF0YUtleSxcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50W2NoaWxkRGF0YUtleV0sIGFnZ3JlZ2F0aW9ucyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhcmVudFtjaGlsZERhdGFLZXldID0gY2hpbGRyZW47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdyb3VwQnlNdWx0aXBsZShhcnJheTogYW55W10sIGdyb3VwaW5nRXhwcmVzc2lvbnM6IElHcm91cGluZ0V4cHJlc3Npb25bXSwgaW5kZXggPSAwKTogR3JvdXBCeVJlY29yZFtdIHtcbiAgICAgICAgY29uc3QgcmVzID0gdGhpcy5ncm91cEJ5KGFycmF5LCBncm91cGluZ0V4cHJlc3Npb25zW2luZGV4XSk7XG5cbiAgICAgICAgaWYgKGluZGV4ICsgMSA8IGdyb3VwaW5nRXhwcmVzc2lvbnMubGVuZ3RoKSB7XG4gICAgICAgICAgIGZvciAoY29uc3QgZ3JvdXBCeVJlY29yZCBvZiByZXMpIHtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkLmdyb3VwcyA9IHRoaXMuZ3JvdXBCeU11bHRpcGxlKGdyb3VwQnlSZWNvcmQucmVjb3JkcywgZ3JvdXBpbmdFeHByZXNzaW9ucywgaW5kZXggKyAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBncm91cEJ5KGFycmF5OiBhbnlbXSwgZ3JvdXBpbmdFeHByZXNzaW9uOiBJR3JvdXBpbmdFeHByZXNzaW9uKTogR3JvdXBCeVJlY29yZFtdIHtcbiAgICAgICAgY29uc3Qga2V5ID0gZ3JvdXBpbmdFeHByZXNzaW9uLmZpZWxkTmFtZTtcbiAgICAgICAgY29uc3QgY29sdW1uID0gdGhpcy5ncmlkPy5nZXRDb2x1bW5CeU5hbWUoa2V5KTtcbiAgICAgICAgY29uc3QgaXNEYXRlVGltZSA9IGNvbHVtbj8uZGF0YVR5cGUgPT09IEdyaWRDb2x1bW5EYXRhVHlwZS5EYXRlIHx8XG4gICAgICAgICAgICBjb2x1bW4/LmRhdGFUeXBlID09PSBHcmlkQ29sdW1uRGF0YVR5cGUuRGF0ZVRpbWUgfHxcbiAgICAgICAgICAgIGNvbHVtbj8uZGF0YVR5cGUgPT09IEdyaWRDb2x1bW5EYXRhVHlwZS5UaW1lO1xuICAgICAgICBjb25zdCBtYXA6IE1hcDxhbnksIEdyb3VwQnlSZWNvcmQ+ID0gbmV3IE1hcDxhbnksIEdyb3VwQnlSZWNvcmQ+KCk7XG4gICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIGFycmF5KSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGlzRGF0ZVRpbWVcbiAgICAgICAgICAgICAgICA/IGZvcm1hdERhdGUocmVjb3JkW2tleV0sIGNvbHVtbi5waXBlQXJncy5mb3JtYXQsIHRoaXMuZ3JpZC5sb2NhbGUpXG4gICAgICAgICAgICAgICAgOiByZWNvcmRba2V5XTtcblxuICAgICAgICAgICAgbGV0IHZhbHVlQ2FzZSA9IHZhbHVlO1xuICAgICAgICAgICAgbGV0IGdyb3VwQnlSZWNvcmQ6IEdyb3VwQnlSZWNvcmQ7XG5cbiAgICAgICAgICAgIGlmIChncm91cGluZ0V4cHJlc3Npb24uaWdub3JlQ2FzZSkge1xuICAgICAgICAgICAgICAgIHZhbHVlQ2FzZSA9IHZhbHVlPy50b1N0cmluZygpLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobWFwLmhhcyh2YWx1ZUNhc2UpKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZCA9IG1hcC5nZXQodmFsdWVDYXNlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZCA9IG5ldyBHcm91cEJ5UmVjb3JkKCk7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZC5rZXkgPSBrZXk7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZC52YWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIGdyb3VwQnlSZWNvcmQucmVjb3JkcyA9IFtdO1xuICAgICAgICAgICAgICAgIG1hcC5zZXQodmFsdWVDYXNlLCBncm91cEJ5UmVjb3JkKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZ3JvdXBCeVJlY29yZC5yZWNvcmRzLnB1c2gocmVjb3JkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKG1hcC52YWx1ZXMoKSk7XG4gICAgfVxufVxuIl19