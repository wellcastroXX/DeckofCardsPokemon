import { DEFAULT_PIVOT_KEYS, PivotDimensionType } from '../grids/pivot-grid/pivot-grid.interface';
import { PivotUtil } from '../grids/pivot-grid/pivot-util';
import { FilteringStrategy } from './filtering-strategy';
import { cloneArray } from '../core/utils';
export class NoopPivotDimensionsStrategy {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new NoopPivotDimensionsStrategy());
    }
    process(collection, _, __) {
        return collection;
    }
}
export class PivotRowDimensionsStrategy {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new PivotRowDimensionsStrategy());
    }
    process(collection, rows, values, cloneStrategy, pivotKeys = DEFAULT_PIVOT_KEYS) {
        let hierarchies;
        let data;
        const prevRowDims = [];
        const currRows = cloneArray(rows, true);
        PivotUtil.assignLevels(currRows);
        if (currRows.length === 0) {
            hierarchies = PivotUtil.getFieldsHierarchy(collection, [{ memberName: '', enabled: true }], PivotDimensionType.Row, pivotKeys, cloneStrategy);
            // generate flat data from the hierarchies
            data = PivotUtil.processHierarchy(hierarchies, pivotKeys, 0, true);
            return data;
        }
        for (const row of currRows) {
            if (!data) {
                // build hierarchies - groups and subgroups
                hierarchies = PivotUtil.getFieldsHierarchy(collection, [row], PivotDimensionType.Row, pivotKeys, cloneStrategy);
                // generate flat data from the hierarchies
                data = PivotUtil.processHierarchy(hierarchies, pivotKeys, 0, true);
                prevRowDims.push(row);
            }
            else {
                PivotUtil.processGroups(data, row, pivotKeys, cloneStrategy);
            }
        }
        return data;
    }
}
export class PivotColumnDimensionsStrategy {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new PivotColumnDimensionsStrategy());
    }
    process(collection, columns, values, cloneStrategy, pivotKeys = DEFAULT_PIVOT_KEYS) {
        const res = this.processHierarchy(collection, columns, values, pivotKeys, cloneStrategy);
        return res;
    }
    processHierarchy(collection, columns, values, pivotKeys, cloneStrategy) {
        const result = [];
        collection.forEach(rec => {
            // apply aggregations based on the created groups and generate column fields based on the hierarchies
            this.groupColumns(rec, columns, values, pivotKeys, cloneStrategy);
            result.push(rec);
        });
        return result;
    }
    groupColumns(rec, columns, values, pivotKeys, cloneStrategy) {
        const children = rec.children;
        if (children && children.size > 0) {
            children.forEach((childRecs) => {
                if (childRecs) {
                    childRecs.forEach(child => {
                        this.groupColumns(child, columns, values, pivotKeys, cloneStrategy);
                    });
                }
            });
        }
        this.applyAggregates(rec, columns, values, pivotKeys, cloneStrategy);
    }
    applyAggregates(rec, columns, values, pivotKeys, cloneStrategy) {
        const leafRecords = this.getLeafs(rec.records, pivotKeys);
        const hierarchy = PivotUtil.getFieldsHierarchy(leafRecords, columns, PivotDimensionType.Column, pivotKeys, cloneStrategy);
        PivotUtil.applyAggregations(rec, hierarchy, values, pivotKeys);
    }
    getLeafs(records, pivotKeys) {
        let leafs = [];
        for (const rec of records) {
            if (rec[pivotKeys.records]) {
                leafs = leafs.concat(this.getLeafs(rec[pivotKeys.records], pivotKeys));
            }
            else {
                leafs.push(rec);
            }
        }
        return leafs;
    }
}
export class DimensionValuesFilteringStrategy extends FilteringStrategy {
    /**
     * Creates a new instance of FormattedValuesFilteringStrategy.
     *
     * @param fields An array of column field names that should be formatted.
     * If omitted the values of all columns which has formatter will be formatted.
     */
    constructor(fields) {
        super();
        this.fields = fields;
    }
    getFieldValue(rec, fieldName, _isDate = false, _isTime = false, grid) {
        const allDimensions = grid.allDimensions;
        const enabledDimensions = allDimensions.filter(x => x && x.enabled);
        const dim = PivotUtil.flatten(enabledDimensions).find(x => x.memberName === fieldName);
        const value = dim.childLevel ? this._getDimensionValueHierarchy(dim, rec).map(x => `[` + x + `]`).join('.') : PivotUtil.extractValueFromDimension(dim, rec);
        return value;
    }
    getFilterItems(column, tree) {
        const grid = column.grid;
        const enabledDimensions = grid.allDimensions.filter(x => x && x.enabled);
        const data = column.grid.gridAPI.filterDataByExpressions(tree);
        const dim = enabledDimensions.find(x => x.memberName === column.field);
        const allValuesHierarchy = PivotUtil.getFieldsHierarchy(data, [dim], PivotDimensionType.Column, grid.pivotKeys, grid.pivotValueCloneStrategy);
        const isNoop = grid.pivotConfiguration.columnStrategy instanceof NoopPivotDimensionsStrategy || grid.pivotConfiguration.rowStrategy instanceof NoopPivotDimensionsStrategy;
        const items = !isNoop ? this._getFilterItems(allValuesHierarchy, grid.pivotKeys) : [{ value: '' }];
        return Promise.resolve(items);
    }
    _getFilterItems(hierarchy, pivotKeys) {
        const items = [];
        hierarchy.forEach((value) => {
            const val = value.value;
            const path = val.split(pivotKeys.columnDimensionSeparator);
            const hierarchicalValue = path.length > 1 ? path.map(x => `[` + x + `]`).join('.') : val;
            const text = path[path.length - 1];
            items.push({
                value: hierarchicalValue,
                label: text,
                children: this._getFilterItems(value.children, pivotKeys)
            });
        });
        return items;
    }
    _getDimensionValueHierarchy(dim, rec) {
        let path = [];
        const value = PivotUtil.extractValueFromDimension(dim, rec);
        path.push(value);
        if (dim.childLevel) {
            const childVals = this._getDimensionValueHierarchy(dim.childLevel, rec);
            path = path.concat(childVals);
        }
        return path;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGl2b3Qtc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZGF0YS1vcGVyYXRpb25zL3Bpdm90LXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxrQkFBa0IsRUFBdUYsa0JBQWtCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUN2TCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDM0QsT0FBTyxFQUFFLGlCQUFpQixFQUFpQixNQUFNLHNCQUFzQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0MsTUFBTSxPQUFPLDJCQUEyQjthQUNyQixjQUFTLEdBQWdDLElBQUksQ0FBQztJQUV0RCxNQUFNLENBQUMsUUFBUTtRQUNsQixPQUFPLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksMkJBQTJCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFFTSxPQUFPLENBQUMsVUFBaUIsRUFBRSxDQUFvQixFQUFFLEVBQWlCO1FBQ3JFLE9BQU8sVUFBVSxDQUFDO0lBQ3RCLENBQUM7O0FBSUwsTUFBTSxPQUFPLDBCQUEwQjthQUNwQixjQUFTLEdBQStCLElBQUksQ0FBQztJQUVyRCxNQUFNLENBQUMsUUFBUTtRQUNsQixPQUFPLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO0lBQ2pGLENBQUM7SUFFTSxPQUFPLENBQ1YsVUFBZSxFQUNmLElBQXVCLEVBQ3ZCLE1BQXFCLEVBQ3JCLGFBQWlDLEVBQ2pDLFlBQXdCLGtCQUFrQjtRQUUxQyxJQUFJLFdBQVcsQ0FBQztRQUNoQixJQUFJLElBQXdCLENBQUM7UUFDN0IsTUFBTSxXQUFX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cnQgeyBDb2x1bW5UeXBlLCBQaXZvdEdyaWRUeXBlIH0gZnJvbSAnLi4vZ3JpZHMvY29tbW9uL2dyaWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IERFRkFVTFRfUElWT1RfS0VZUywgSVBpdm90RGltZW5zaW9uLCBJUGl2b3REaW1lbnNpb25TdHJhdGVneSwgSVBpdm90R3JpZFJlY29yZCwgSVBpdm90S2V5cywgSVBpdm90VmFsdWUsIFBpdm90RGltZW5zaW9uVHlwZSB9IGZyb20gJy4uL2dyaWRzL3Bpdm90LWdyaWQvcGl2b3QtZ3JpZC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUGl2b3RVdGlsIH0gZnJvbSAnLi4vZ3JpZHMvcGl2b3QtZ3JpZC9waXZvdC11dGlsJztcbmltcG9ydCB7IEZpbHRlcmluZ1N0cmF0ZWd5LCBJZ3hGaWx0ZXJJdGVtIH0gZnJvbSAnLi9maWx0ZXJpbmctc3RyYXRlZ3knO1xuaW1wb3J0IHsgY2xvbmVBcnJheSB9IGZyb20gJy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgSUZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSB9IGZyb20gJy4vZmlsdGVyaW5nLWV4cHJlc3Npb25zLXRyZWUnO1xuaW1wb3J0IHsgSURhdGFDbG9uZVN0cmF0ZWd5IH0gZnJvbSAnLi9kYXRhLWNsb25lLXN0cmF0ZWd5JztcblxuZXhwb3J0IGNsYXNzIE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSBpbXBsZW1lbnRzIElQaXZvdERpbWVuc2lvblN0cmF0ZWd5IHtcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6IE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSA9IG51bGw7XG5cbiAgICBwdWJsaWMgc3RhdGljIGluc3RhbmNlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW5zdGFuY2UgfHwgKHRoaXMuX2luc3RhbmNlID0gbmV3IE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSgpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcHJvY2Vzcyhjb2xsZWN0aW9uOiBhbnlbXSwgXzogSVBpdm90RGltZW5zaW9uW10sIF9fOiBJUGl2b3RWYWx1ZVtdKTogYW55W10ge1xuICAgICAgICByZXR1cm4gY29sbGVjdGlvbjtcbiAgICB9XG59XG5cblxuZXhwb3J0IGNsYXNzIFBpdm90Um93RGltZW5zaW9uc1N0cmF0ZWd5IGltcGxlbWVudHMgSVBpdm90RGltZW5zaW9uU3RyYXRlZ3kge1xuICAgIHByaXZhdGUgc3RhdGljIF9pbnN0YW5jZTogUGl2b3RSb3dEaW1lbnNpb25zU3RyYXRlZ3kgPSBudWxsO1xuXG4gICAgcHVibGljIHN0YXRpYyBpbnN0YW5jZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlIHx8ICh0aGlzLl9pbnN0YW5jZSA9IG5ldyBQaXZvdFJvd0RpbWVuc2lvbnNTdHJhdGVneSgpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcHJvY2VzcyhcbiAgICAgICAgY29sbGVjdGlvbjogYW55LFxuICAgICAgICByb3dzOiBJUGl2b3REaW1lbnNpb25bXSxcbiAgICAgICAgdmFsdWVzOiBJUGl2b3RWYWx1ZVtdLFxuICAgICAgICBjbG9uZVN0cmF0ZWd5OiBJRGF0YUNsb25lU3RyYXRlZ3ksXG4gICAgICAgIHBpdm90S2V5czogSVBpdm90S2V5cyA9IERFRkFVTFRfUElWT1RfS0VZUyxcbiAgICApOiBJUGl2b3RHcmlkUmVjb3JkW10ge1xuICAgICAgICBsZXQgaGllcmFyY2hpZXM7XG4gICAgICAgIGxldCBkYXRhOiBJUGl2b3RHcmlkUmVjb3JkW107XG4gICAgICAgIGNvbnN0IHByZXZSb3dEaW1zID0gW107XG4gICAgICAgIGNvbnN0IGN1cnJSb3dzID0gY2xvbmVBcnJheShyb3dzLCB0cnVlKTtcbiAgICAgICAgUGl2b3RVdGlsLmFzc2lnbkxldmVscyhjdXJyUm93cyk7XG5cbiAgICAgICAgaWYgKGN1cnJSb3dzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgaGllcmFyY2hpZXMgPSBQaXZvdFV0aWwuZ2V0RmllbGRzSGllcmFyY2h5KGNvbGxlY3Rpb24sIFt7IG1lbWJlck5hbWU6ICcnLCBlbmFibGVkOiB0cnVlIH1dLCBQaXZvdERpbWVuc2lvblR5cGUuUm93LCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgLy8gZ2VuZXJhdGUgZmxhdCBkYXRhIGZyb20gdGhlIGhpZXJhcmNoaWVzXG4gICAgICAgICAgICBkYXRhID0gUGl2b3RVdGlsLnByb2Nlc3NIaWVyYXJjaHkoaGllcmFyY2hpZXMsIHBpdm90S2V5cywgMCwgdHJ1ZSk7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3Qgcm93IG9mIGN1cnJSb3dzKSB7XG4gICAgICAgICAgICBpZiAoIWRhdGEpIHtcbiAgICAgICAgICAgICAgICAvLyBidWlsZCBoaWVyYXJjaGllcyAtIGdyb3VwcyBhbmQgc3ViZ3JvdXBzXG4gICAgICAgICAgICAgICAgaGllcmFyY2hpZXMgPSBQaXZvdFV0aWwuZ2V0RmllbGRzSGllcmFyY2h5KGNvbGxlY3Rpb24sIFtyb3ddLCBQaXZvdERpbWVuc2lvblR5cGUuUm93LCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgICAgIC8vIGdlbmVyYXRlIGZsYXQgZGF0YSBmcm9tIHRoZSBoaWVyYXJjaGllc1xuICAgICAgICAgICAgICAgIGRhdGEgPSBQaXZvdFV0aWwucHJvY2Vzc0hpZXJhcmNoeShoaWVyYXJjaGllcywgcGl2b3RLZXlzLCAwLCB0cnVlKTtcbiAgICAgICAgICAgICAgICBwcmV2Um93RGltcy5wdXNoKHJvdyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIFBpdm90VXRpbC5wcm9jZXNzR3JvdXBzKGRhdGEsIHJvdywgcGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQaXZvdENvbHVtbkRpbWVuc2lvbnNTdHJhdGVneSBpbXBsZW1lbnRzIElQaXZvdERpbWVuc2lvblN0cmF0ZWd5IHtcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6IFBpdm90Um93RGltZW5zaW9uc1N0cmF0ZWd5ID0gbnVsbDtcblxuICAgIHB1YmxpYyBzdGF0aWMgaW5zdGFuY2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZSB8fCAodGhpcy5faW5zdGFuY2UgPSBuZXcgUGl2b3RDb2x1bW5EaW1lbnNpb25zU3RyYXRlZ3koKSk7XG4gICAgfVxuXG4gICAgcHVibGljIHByb2Nlc3MoXG4gICAgICAgIGNvbGxlY3Rpb246IElQaXZvdEdyaWRSZWNvcmRbXSxcbiAgICAgICAgY29sdW1uczogSVBpdm90RGltZW5zaW9uW10sXG4gICAgICAgIHZhbHVlczogSVBpdm90VmFsdWVbXSxcbiAgICAgICAgY2xvbmVTdHJhdGVneTogSURhdGFDbG9uZVN0cmF0ZWd5LFxuICAgICAgICBwaXZvdEtleXM6IElQaXZvdEtleXMgPSBERUZBVUxUX1BJVk9UX0tFWVNcbiAgICApOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IHJlcyA9IHRoaXMucHJvY2Vzc0hpZXJhcmNoeShjb2xsZWN0aW9uLCBjb2x1bW5zLCB2YWx1ZXMsIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSk7XG4gICAgICAgIHJldHVybiByZXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwcm9jZXNzSGllcmFyY2h5KGNvbGxlY3Rpb246IElQaXZvdEdyaWRSZWNvcmRbXSwgY29sdW1uczogSVBpdm90RGltZW5zaW9uW10sIHZhbHVlcywgcGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5KSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogSVBpdm90R3JpZFJlY29yZFtdID0gW107XG4gICAgICAgIGNvbGxlY3Rpb24uZm9yRWFjaChyZWMgPT4ge1xuICAgICAgICAgICAgLy8gYXBwbHkgYWdncmVnYXRpb25zIGJhc2VkIG9uIHRoZSBjcmVhdGVkIGdyb3VwcyBhbmQgZ2VuZXJhdGUgY29sdW1uIGZpZWxkcyBiYXNlZCBvbiB0aGUgaGllcmFyY2hpZXNcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBDb2x1bW5zKHJlYywgY29sdW1ucywgdmFsdWVzLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgcmVzdWx0LnB1c2gocmVjKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBncm91cENvbHVtbnMocmVjOiBJUGl2b3RHcmlkUmVjb3JkLCBjb2x1bW5zLCB2YWx1ZXMsIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSkge1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IHJlYy5jaGlsZHJlbjtcbiAgICAgICAgaWYgKGNoaWxkcmVuICYmIGNoaWxkcmVuLnNpemUgPiAwKSB7XG4gICAgICAgICAgICBjaGlsZHJlbi5mb3JFYWNoKChjaGlsZFJlY3MpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGRSZWNzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoaWxkUmVjcy5mb3JFYWNoKGNoaWxkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ3JvdXBDb2x1bW5zKGNoaWxkLCBjb2x1bW5zLCB2YWx1ZXMsIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hcHBseUFnZ3JlZ2F0ZXMocmVjLCBjb2x1bW5zLCB2YWx1ZXMsIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhcHBseUFnZ3JlZ2F0ZXMocmVjLCBjb2x1bW5zLCB2YWx1ZXMsIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSkge1xuICAgICAgICBjb25zdCBsZWFmUmVjb3JkcyA9IHRoaXMuZ2V0TGVhZnMocmVjLnJlY29yZHMsIHBpdm90S2V5cyk7XG4gICAgICAgIGNvbnN0IGhpZXJhcmNoeSA9IFBpdm90VXRpbC5nZXRGaWVsZHNIaWVyYXJjaHkobGVhZlJlY29yZHMsIGNvbHVtbnMsIFBpdm90RGltZW5zaW9uVHlwZS5Db2x1bW4sIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSk7XG4gICAgICAgIFBpdm90VXRpbC5hcHBseUFnZ3JlZ2F0aW9ucyhyZWMsIGhpZXJhcmNoeSwgdmFsdWVzLCBwaXZvdEtleXMpXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRMZWFmcyhyZWNvcmRzLCBwaXZvdEtleXMpIHtcbiAgICAgICAgbGV0IGxlYWZzID0gW107XG4gICAgICAgIGZvciAoY29uc3QgcmVjIG9mIHJlY29yZHMpIHtcbiAgICAgICAgICAgIGlmIChyZWNbcGl2b3RLZXlzLnJlY29yZHNdKSB7XG4gICAgICAgICAgICAgICAgbGVhZnMgPSBsZWFmcy5jb25jYXQodGhpcy5nZXRMZWFmcyhyZWNbcGl2b3RLZXlzLnJlY29yZHNdLCBwaXZvdEtleXMpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbGVhZnMucHVzaChyZWMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBsZWFmcztcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEaW1lbnNpb25WYWx1ZXNGaWx0ZXJpbmdTdHJhdGVneSBleHRlbmRzIEZpbHRlcmluZ1N0cmF0ZWd5IHtcblxuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBuZXcgaW5zdGFuY2Ugb2YgRm9ybWF0dGVkVmFsdWVzRmlsdGVyaW5nU3RyYXRlZ3kuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gZmllbGRzIEFuIGFycmF5IG9mIGNvbHVtbiBmaWVsZCBuYW1lcyB0aGF0IHNob3VsZCBiZSBmb3JtYXR0ZWQuXG4gICAgICogSWYgb21pdHRlZCB0aGUgdmFsdWVzIG9mIGFsbCBjb2x1bW5zIHdoaWNoIGhhcyBmb3JtYXR0ZXIgd2lsbCBiZSBmb3JtYXR0ZWQuXG4gICAgICovXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmaWVsZHM/OiBzdHJpbmdbXSkge1xuICAgICAgICBzdXBlcigpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBvdmVycmlkZSBnZXRGaWVsZFZhbHVlKHJlYzogYW55LCBmaWVsZE5hbWU6IHN0cmluZywgX2lzRGF0ZSA9IGZhbHNlLCBfaXNUaW1lID0gZmFsc2UsXG4gICAgICAgIGdyaWQ/OiBQaXZvdEdyaWRUeXBlKTogYW55IHtcbiAgICAgICAgY29uc3QgYWxsRGltZW5zaW9ucyA9IGdyaWQuYWxsRGltZW5zaW9ucztcbiAgICAgICAgY29uc3QgZW5hYmxlZERpbWVuc2lvbnMgPSBhbGxEaW1lbnNpb25zLmZpbHRlcih4ID0+IHggJiYgeC5lbmFibGVkKTtcbiAgICAgICAgY29uc3QgZGltIDpJUGl2b3REaW1lbnNpb24gPSBQaXZvdFV0aWwuZmxhdHRlbihlbmFibGVkRGltZW5zaW9ucykuZmluZCh4ID0+IHgubWVtYmVyTmFtZSA9PT0gZmllbGROYW1lKTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBkaW0uY2hpbGRMZXZlbCA/IHRoaXMuX2dldERpbWVuc2lvblZhbHVlSGllcmFyY2h5KGRpbSwgcmVjKS5tYXAoeCA9PiBgW2AgKyB4ICtgXWApLmpvaW4oJy4nKSA6IFBpdm90VXRpbC5leHRyYWN0VmFsdWVGcm9tRGltZW5zaW9uKGRpbSwgcmVjKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIHB1YmxpYyBvdmVycmlkZSBnZXRGaWx0ZXJJdGVtcyhjb2x1bW46IENvbHVtblR5cGUsIHRyZWU6IElGaWx0ZXJpbmdFeHByZXNzaW9uc1RyZWUpOiBQcm9taXNlPElneEZpbHRlckl0ZW1bXT4ge1xuICAgICAgICBjb25zdCBncmlkID0gKGNvbHVtbi5ncmlkIGFzIGFueSk7XG4gICAgICAgIGNvbnN0IGVuYWJsZWREaW1lbnNpb25zID0gZ3JpZC5hbGxEaW1lbnNpb25zLmZpbHRlcih4ID0+IHggJiYgeC5lbmFibGVkKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IGNvbHVtbi5ncmlkLmdyaWRBUEkuZmlsdGVyRGF0YUJ5RXhwcmVzc2lvbnModHJlZSk7XG4gICAgICAgIGNvbnN0IGRpbSA9IGVuYWJsZWREaW1lbnNpb25zLmZpbmQoeCA9PiB4Lm1lbWJlck5hbWUgPT09IGNvbHVtbi5maWVsZCk7XG4gICAgICAgIGNvbnN0IGFsbFZhbHVlc0hpZXJhcmNoeSA9IFBpdm90VXRpbC5nZXRGaWVsZHNIaWVyYXJjaHkoXG4gICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgW2RpbV0sXG4gICAgICAgICAgICBQaXZvdERpbWVuc2lvblR5cGUuQ29sdW1uLFxuICAgICAgICAgICAgZ3JpZC5waXZvdEtleXMsXG4gICAgICAgICAgICBncmlkLnBpdm90VmFsdWVDbG9uZVN0cmF0ZWd5XG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGlzTm9vcCA9IGdyaWQucGl2b3RDb25maWd1cmF0aW9uLmNvbHVtblN0cmF0ZWd5IGluc3RhbmNlb2YgTm9vcFBpdm90RGltZW5zaW9uc1N0cmF0ZWd5IHx8IGdyaWQucGl2b3RDb25maWd1cmF0aW9uLnJvd1N0cmF0ZWd5IGluc3RhbmNlb2YgTm9vcFBpdm90RGltZW5zaW9uc1N0cmF0ZWd5O1xuICAgICAgICBjb25zdCBpdGVtczogSWd4RmlsdGVySXRlbVtdID0gIWlzTm9vcCA/IHRoaXMuX2dldEZpbHRlckl0ZW1zKGFsbFZhbHVlc0hpZXJhcmNoeSwgZ3JpZC5waXZvdEtleXMpIDogW3t2YWx1ZSA6ICcnfV07XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoaXRlbXMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldEZpbHRlckl0ZW1zKGhpZXJhcmNoeTogTWFwPHN0cmluZywgYW55PiwgcGl2b3RLZXlzOiBJUGl2b3RLZXlzKSA6IElneEZpbHRlckl0ZW1bXSB7XG4gICAgICAgIGNvbnN0IGl0ZW1zOiAgSWd4RmlsdGVySXRlbVtdID0gW107XG4gICAgICAgIGhpZXJhcmNoeS5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsID0gdmFsdWUudmFsdWU7XG4gICAgICAgICAgICBjb25zdCBwYXRoID0gdmFsLnNwbGl0KHBpdm90S2V5cy5jb2x1bW5EaW1lbnNpb25TZXBhcmF0b3IpO1xuICAgICAgICAgICAgY29uc3QgaGllcmFyY2hpY2FsVmFsdWUgPSBwYXRoLmxlbmd0aCA+IDEgPyBwYXRoLm1hcCh4ID0+IGBbYCArIHggK2BdYCkuam9pbignLicpIDogdmFsO1xuICAgICAgICAgICAgY29uc3QgdGV4dCA9IHBhdGhbcGF0aC5sZW5ndGggLTFdO1xuICAgICAgICAgICAgaXRlbXMucHVzaCh7XG4gICAgICAgICAgICAgICAgdmFsdWU6IGhpZXJhcmNoaWNhbFZhbHVlLFxuICAgICAgICAgICAgICAgIGxhYmVsOiB0ZXh0LFxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOiB0aGlzLl9nZXRGaWx0ZXJJdGVtcyh2YWx1ZS5jaGlsZHJlbiwgcGl2b3RLZXlzKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gaXRlbXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0RGltZW5zaW9uVmFsdWVIaWVyYXJjaHkoZGltOiBJUGl2b3REaW1lbnNpb24sIHJlYzogYW55KSA6IHN0cmluZ1tdIHtcbiAgICAgICAgbGV0IHBhdGggPSBbXTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBQaXZvdFV0aWwuZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihkaW0sIHJlYyk7XG4gICAgICAgIHBhdGgucHVzaCh2YWx1ZSk7XG4gICAgICAgIGlmIChkaW0uY2hpbGRMZXZlbCkge1xuICAgICAgICAgICAgY29uc3QgY2hpbGRWYWxzID0gdGhpcy5fZ2V0RGltZW5zaW9uVmFsdWVIaWVyYXJjaHkoZGltLmNoaWxkTGV2ZWwsIHJlYyk7XG4gICAgICAgICAgICBwYXRoID0gcGF0aC5jb25jYXQoY2hpbGRWYWxzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcGF0aDtcbiAgICB9XG59XG4iXX0=